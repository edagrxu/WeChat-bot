<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼ä¸šå¾®ä¿¡æ—¥æŠ¥æé†’æœºå™¨äººé…ç½®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‹¹æœç£¨ç ‚ç»ç’ƒæ•ˆæœ */
        .glass-container {
            backdrop-filter: blur(10px) saturate(180%);
            -webkit-backdrop-filter: blur(10px) saturate(180%);
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            border: 1px solid rgba(209, 213, 219, 0.3);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        /* ç§»åŠ¨ç«¯å®‰å…¨åŒºåŸŸé€‚é… */
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-500 min-h-screen p-4">

    <div class="max-w-xl mx-auto space-y-6">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white pt-4">ğŸ¤– æé†’æœºå™¨äººé…ç½®</h1>

        <div id="status-monitor" class="glass-container p-5 space-y-3">
            <h2 class="text-xl font-semibold dark:text-gray-900">ğŸ”§ çŠ¶æ€ç›‘æ§</h2>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>ç³»ç»ŸçŠ¶æ€: <span id="sys-status" class="font-bold text-green-600">è¿è¡Œä¸­</span></div>
                <div>ä¸‹æ¬¡æ¨é€: <span id="next-push" class="font-bold">N/A</span></div>
                <div>æ€»æ¨é€æ¬¡æ•°: <span id="total-pushes" class="font-bold">0</span></div>
                <div>æˆåŠŸç‡: <span id="success-rate" class="font-bold">N/A</span></div>
            </div>
        </div>

        <div class="glass-container p-5 space-y-4">
            <h2 class="text-xl font-semibold dark:text-gray-900">âš™ï¸ ä¼ä¸šå¾®ä¿¡æœºå™¨äººè®¾ç½®</h2>
            <label class="block">
                <span class="text-sm font-medium dark:text-gray-900">Webhook URL</span>
                <input type="url" id="webhook-url" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 dark:bg-white/80" placeholder="https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxxxxxx">
            </label>
            <button onclick="testConnection()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-200">
                æµ‹è¯•è¿æ¥
            </button>
        </div>

        <div class="glass-container p-5 space-y-4">
            <h2 class="text-xl font-semibold dark:text-gray-900">ğŸ—“ï¸ æ¨é€è®¡åˆ’è®¾ç½®</h2>
            
            <label class="block">
                <span class="text-sm font-medium dark:text-gray-900">æ¨é€é¢‘ç‡é€‰é¡¹</span>
                <select id="push-frequency" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 dark:bg-white/80">
                    <option value="å…³é—­è‡ªåŠ¨æ¨é€">å…³é—­è‡ªåŠ¨æ¨é€ (ä»…æ‰‹åŠ¨)</option>
                    <option value="æ¯æ—¥æ¨é€">æ¯æ—¥æ¨é€</option>
                    <option value="æ³•å®šå·¥ä½œæ—¥">æ³•å®šå·¥ä½œæ—¥ (å‘¨ä¸€è‡³å‘¨äº”ï¼Œæ³•å®šèŠ‚å‡æ—¥é™¤å¤–)</option>
                    <option value="æ¯å‘¨æ¨é€">æ¯å‘¨æ¨é€ (æ¯å‘¨ä¸€)</option>
                    <option value="æ¯æœˆæ¨é€">æ¯æœˆæ¨é€ (æ¯æœˆ1å·)</option>
                </select>
            </label>

            <div id="push-times-container" class="space-y-2">
                <span class="text-sm font-medium dark:text-gray-900 block">æ¨é€æ—¶é—´ (HH:MM)</span>
                </div>
            <button onclick="addTimeInput()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded transition duration-200 mt-2">
                + æ·»åŠ æ¨é€æ—¶é—´
            </button>

            <button onclick="saveConfig()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded transition duration-200 mt-4">
                ä¿å­˜é…ç½®å¹¶å¯åŠ¨è‡ªåŠ¨æ¨é€
            </button>
        </div>

        <div class="glass-container p-5">
            <h2 class="text-xl font-semibold dark:text-gray-900">ğŸš€ æ‰‹åŠ¨æ¨é€</h2>
            <button id="manual-push-btn" onclick="manualPush()" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded transition duration-200 mt-4">
                ç«‹å³æ¨é€
            </button>
        </div>

        <div class="glass-container p-5">
            <h2 class="text-xl font-semibold dark:text-gray-900">ğŸ“ æ¨é€æ¨¡æ¿</h2>
            <div id="template-display" class="text-sm text-gray-700 dark:text-gray-900 mb-3">æœªè®¾ç½®æ¨é€æ¨¡æ¿ã€‚</div>
            <button id="edit-template-btn" onclick="openTemplateEditor()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-200">
                ç¼–è¾‘æ¨¡æ¿
            </button>

            <div id="template-editor" class="hidden mt-3">
                <label class="block">
                    <span class="text-sm font-medium dark:text-gray-900">æ¨¡æ¿å†…å®¹ï¼ˆæ”¯æŒç®€å•æ–‡æœ¬/Markdownï¼‰</span>
                    <textarea id="template-textarea" class="mt-1 block w-full h-40 rounded-md border-gray-300 shadow-sm p-2 dark:bg-white/80" placeholder="åœ¨è¿™é‡Œè¾“å…¥æ¨é€æ¨¡æ¿..."></textarea>
                </label>
                <div class="flex space-x-2 mt-2">
                    <button onclick="saveTemplate()" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">ä¿å­˜æ¨¡æ¿</button>
                    <button onclick="closeTemplateEditor()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <div id="push-history" class="glass-container p-5 space-y-3 mb-8">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-semibold dark:text-gray-900">ğŸ“‹ æ¨é€å†å²</h2>
                <button onclick="fetchHistory()" class="text-sm text-blue-500 hover:text-blue-700">ğŸ”„ åˆ·æ–°</button>
            </div>
            <ul id="history-list" class="space-y-2">
                </ul>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetchConfig();
            fetchStatus();
            fetchHistory();
        });

        const timeContainer = document.getElementById('push-times-container');

        // --- æ—¶é—´è¾“å…¥æ¡†ç®¡ç† ---
        function addTimeInput(value = '') {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex space-x-2 items-center';
            
            const input = document.createElement('input');
            input.type = 'time';
            input.className = 'flex-grow rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 dark:bg-white/80';
            input.value = value;
            
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = 'ğŸ—‘ï¸';
            deleteBtn.className = 'text-red-500 hover:text-red-700 p-2 transition duration-200';
            deleteBtn.onclick = () => {
                if (timeContainer.children.length > 1) {
                    timeContainer.removeChild(wrapper);
                } else {
                    alert('è‡³å°‘ä¿ç•™ä¸€ä¸ªæ¨é€æ—¶é—´ç‚¹ï¼');
                }
            };

            wrapper.appendChild(input);
            wrapper.appendChild(deleteBtn);
            timeContainer.appendChild(wrapper);
        }

        // --- API äº¤äº’å‡½æ•° ---
        async function fetchConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                document.getElementById('webhook-url').value = config.webhook_url || '';
                document.getElementById('push-frequency').value = config.push_frequency || 'æ¯æ—¥æ¨é€';
                // æ˜¾ç¤ºæ¨¡æ¿å†…å®¹
                const tpl = config.push_template || '';
                if (tpl) {
                    document.getElementById('template-display').textContent = tpl;
                } else {
                    document.getElementById('template-display').textContent = 'æœªè®¾ç½®æ¨é€æ¨¡æ¿ã€‚';
                }
                
                timeContainer.innerHTML = ''; // æ¸…ç©ºæ—§çš„
                if (config.push_times && config.push_times.length > 0) {
                    config.push_times.forEach(time => addTimeInput(time));
                } else {
                    addTimeInput('09:00'); // é»˜è®¤ä¸€ä¸ªæ—¶é—´
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            }
        }

        async function saveConfig() {
            const times = Array.from(timeContainer.querySelectorAll('input[type="time"]')).map(input => input.value).filter(v => v);
            const newConfig = {
                webhook_url: document.getElementById('webhook-url').value,
                push_frequency: document.getElementById('push-frequency').value,
                push_times: times,
                push_template: document.getElementById('template-textarea') ? document.getElementById('template-textarea').value : undefined
            };
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(newConfig)
                });
                const result = await response.json();
                alert(result.message);
                fetchStatus(); // æ›´æ–°çŠ¶æ€
            } catch (error) {
                alert('ä¿å­˜é…ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åç«¯æœåŠ¡');
            }
        }

        async function manualPush() {
            document.getElementById('manual-push-btn').disabled = true;
            document.getElementById('manual-push-btn').textContent = 'æ¨é€ä¸­...';
            try {
                const response = await fetch('/api/push/manual', { method: 'POST' });
                const result = await response.json();
                alert(result.message);
                fetchStatus();
                fetchHistory();
            } catch (error) {
                alert('æ‰‹åŠ¨æ¨é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®å’Œç½‘ç»œ');
            } finally {
                document.getElementById('manual-push-btn').disabled = false;
                document.getElementById('manual-push-btn').textContent = 'ç«‹å³æ¨é€';
            }
        }

        // --- æ¨¡æ¿ç¼–è¾‘ç›¸å…³ ---
        function openTemplateEditor() {
            const editor = document.getElementById('template-editor');
            const textarea = document.getElementById('template-textarea');
            const display = document.getElementById('template-display');
            textarea.value = display.textContent === 'æœªè®¾ç½®æ¨é€æ¨¡æ¿ã€‚' ? '' : display.textContent;
            editor.classList.remove('hidden');
        }

        function closeTemplateEditor() {
            document.getElementById('template-editor').classList.add('hidden');
        }

        async function saveTemplate() {
            const tpl = document.getElementById('template-textarea').value;
            // ç®€å•æœ¬åœ°æ›´æ–°æ˜¾ç¤ºå¹¶æäº¤åˆ° saveConfig
            document.getElementById('template-display').textContent = tpl || 'æœªè®¾ç½®æ¨é€æ¨¡æ¿ã€‚';
            closeTemplateEditor();
            // è°ƒç”¨ä¿å­˜é…ç½®ä»¥ä¾¿åç«¯æŒä¹…åŒ–æ¨¡æ¿
            await saveConfig();
        }

        async function testConnection() {
            const webhookUrl = document.getElementById('webhook-url').value;
            if (!webhookUrl) {
                alert('è¯·å…ˆå¡«å†™ Webhook URL');
                return;
            }

            try {
                const response = await fetch('/api/test-connection', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ webhook_url: webhookUrl })
                });
                const result = await response.json();
                if (response.ok && result.status === 'success') {
                    alert(result.message || 'è¿æ¥æµ‹è¯•æˆåŠŸï¼');
                } else {
                    alert(result.message || 'è¿æ¥æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Webhook URL å’ŒæœåŠ¡å™¨çš„ç½‘ç»œè¿é€šæ€§ã€‚');
                }
            } catch (error) {
                alert('æµ‹è¯•è¿æ¥å¤±è´¥ï¼ˆå‰ç«¯è¯·æ±‚é”™è¯¯ï¼‰ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯ç”¨');
            }
        }

        async function fetchStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                
                document.getElementById('sys-status').textContent = status.status ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
                document.getElementById('next-push').textContent = status.next_push_time;
                document.getElementById('total-pushes').textContent = status.total_pushes;
                document.getElementById('success-rate').textContent = status.success_rate;
            } catch (error) {
                console.error('è·å–çŠ¶æ€å¤±è´¥:', error);
                document.getElementById('sys-status').textContent = 'è¿æ¥å¤±è´¥';
            }
            // æ¯ 5 ç§’åˆ·æ–°ä¸€æ¬¡çŠ¶æ€
            setTimeout(fetchStatus, 5000); 
        }

        async function fetchHistory() {
            try {
                const response = await fetch('/api/history');
                const data = await response.json();
                const historyList = document.getElementById('history-list');
                historyList.innerHTML = '';
                
                if (data.history.length === 0) {
                    historyList.innerHTML = '<li class="text-sm text-gray-500">æš‚æ— æ¨é€å†å²è®°å½•ã€‚</li>';
                    return;
                }

                data.history.forEach(record => {
                    const listItem = document.createElement('li');
                    const statusColor = record.status === 'æˆåŠŸ' ? 'text-green-600' : 'text-red-600';
                    listItem.className = `p-2 rounded-md ${record.status === 'æˆåŠŸ' ? 'bg-green-100/50' : 'bg-red-100/50'} text-sm dark:text-gray-900`;
                    listItem.innerHTML = `
                        <div class="font-bold">${record.time} (${record.type})</div>
                        <div class="ml-2">çŠ¶æ€: <span class="${statusColor}">${record.status}</span></div>
                        <div class="ml-2 text-xs text-gray-700 truncate">ä¿¡æ¯: ${record.message}</div>
                    `;
                    historyList.appendChild(listItem);
                });
            } catch (error) {
                console.error('è·å–å†å²è®°å½•å¤±è´¥:', error);
            }
        }
    </script>
</body>
</html>